<!-- å°ç« å­—é«”å³æ™‚é è¦½ç³»çµ± - æ•´åˆè‡ªè¨‚å­—é«”ç‰ˆ -->
<div id="stamp-custom-font-widget" style="position: relative; isolation: isolate;">
    <style>
        /* åŸºç¤æ¨£å¼ */
        #stamp-custom-font-widget {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif;
            background: #ffffff;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        
        #stamp-custom-font-widget * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        /* æ¨™é¡Œ */
        #stamp-custom-font-widget .scfw-header {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
            margin-bottom: 25px;
        }
        
        #stamp-custom-font-widget .scfw-title {
            font-size: 22px;
            color: #333;
            margin-bottom: 8px;
        }
        
        #stamp-custom-font-widget .scfw-subtitle {
            font-size: 14px;
            color: #666;
        }
        
        /* æ§åˆ¶å€ */
        #stamp-custom-font-widget .scfw-controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }
        
        #stamp-custom-font-widget .scfw-control-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 15px;
            align-items: end;
        }
        
        #stamp-custom-font-widget .scfw-control {
            display: flex;
            flex-direction: column;
        }
        
        #stamp-custom-font-widget .scfw-label {
            font-size: 14px;
            font-weight: bold;
            color: #555;
            margin-bottom: 8px;
        }
        
        #stamp-custom-font-widget .scfw-input,
        #stamp-custom-font-widget .scfw-select {
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 15px;
            font-family: inherit;
            width: 100%;
            transition: all 0.2s;
        }
        
        #stamp-custom-font-widget .scfw-input:focus,
        #stamp-custom-font-widget .scfw-select:focus {
            outline: none;
            border-color: #80bdff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        
        /* è¼‰å…¥æŒ‰éˆ• */
        #stamp-custom-font-widget .scfw-load-btn {
            width: 100%;
            padding: 12px;
            background: #B5D5B0;
            color: #333;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.2s;
        }
        
        #stamp-custom-font-widget .scfw-load-btn:hover {
            background: #97BF90;
            transform: translateY(-2px);
        }
        
        #stamp-custom-font-widget .scfw-load-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        /* å­—é«”ç¶²æ ¼ */
        #stamp-custom-font-widget .scfw-font-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            min-height: 200px;
        }
        
        #stamp-custom-font-widget .scfw-font-card {
            background: white;
            border: 3px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        #stamp-custom-font-widget .scfw-font-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
            border-color: #B5D5B0;
        }
        
        #stamp-custom-font-widget .scfw-font-card.selected {
            border-color: #28a745;
            background: #f0fff4;
        }
        
        #stamp-custom-font-widget .scfw-font-card.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background: #28a745;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            z-index: 10;
        }
        
        /* å°ç« é è¦½ */
        #stamp-custom-font-widget .scfw-stamp-preview {
            padding: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            background: #fafafa;
            position: relative;
        }
        
        #stamp-custom-font-widget .scfw-stamp {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        #stamp-custom-font-widget .scfw-stamp.æ–¹å½¢ {
            width: 160px;
            height: 160px;
            border: 4px solid #dc3545;
            border-radius: 0;
        }
        
        #stamp-custom-font-widget .scfw-stamp.åœ“å½¢,
        #stamp-custom-font-widget .scfw-stamp.æ©¢åœ“å½¢ {
            width: 160px;
            height: 160px;
            border: 4px solid #dc3545;
            border-radius: 50%;
        }
        
        #stamp-custom-font-widget .scfw-stamp.æ©¢åœ“å½¢ {
            width: 190px;
            height: 150px;
        }
        
        #stamp-custom-font-widget .scfw-stamp.é•·æ–¹å½¢ {
            width: 200px;
            height: 140px;
            border: 4px solid #dc3545;
            border-radius: 0;
        }
        
        #stamp-custom-font-widget .scfw-stamp-text {
            font-size: 40px;
            color: #dc3545;
            font-weight: bold;
            line-height: 1.2;
            text-align: center;
        }
        
        #stamp-custom-font-widget .scfw-stamp-pattern {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 20px;
            opacity: 0.4;
        }
        
        /* å­—é«”åç¨± */
        #stamp-custom-font-widget .scfw-font-name {
            padding: 12px;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            background: #f0f0f0;
            color: #333;
            border-top: 1px solid #e0e0e0;
        }
        
        /* è¼‰å…¥ä¸­ */
        #stamp-custom-font-widget .scfw-loading {
            text-align: center;
            padding: 60px;
            color: #999;
        }
        
        #stamp-custom-font-widget .scfw-font-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
            color: #999;
        }
        
        /* åŒæ­¥ç‹€æ…‹ */
        #stamp-custom-font-widget .scfw-sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* éŸ¿æ‡‰å¼ */
        @media (max-width: 768px) {
            #stamp-custom-font-widget .scfw-control-grid {
                grid-template-columns: 1fr;
            }
            
            #stamp-custom-font-widget .scfw-font-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            #stamp-custom-font-widget .scfw-stamp {
                transform: scale(0.85);
            }
        }
    </style>
    
    <!-- åŒæ­¥ç‹€æ…‹ -->
    <div class="scfw-sync-status" id="scfw-sync-status">âœ… å·²åŒæ­¥</div>
    
    <!-- ä¸»å®¹å™¨ -->
    <div class="scfw-header">
        <h2 class="scfw-title">ğŸ¯ å°ç« å­—é«”å³æ™‚é è¦½ç³»çµ±</h2>
        <p class="scfw-subtitle">ä½¿ç”¨è‡ªè¨‚å­—é«”ï¼Œå³æ™‚é è¦½ä¸¦åŒæ­¥åˆ°å•†å“é¸é …</p>
    </div>
    
    <!-- æ§åˆ¶å€ -->
    <div class="scfw-controls">
        <div class="scfw-control-grid">
            <div class="scfw-control">
                <label class="scfw-label">å°ç« æ–‡å­—</label>
                <input type="text" 
                       class="scfw-input" 
                       id="scfw-text" 
                       placeholder="è¼¸å…¥æ–‡å­—ï¼ˆæœ€å¤š6å­—ï¼‰" 
                       maxlength="6" 
                       value="å°ç« é è¦½">
            </div>
            
            <div class="scfw-control">
                <label class="scfw-label">å°ç« å½¢ç‹€</label>
                <select class="scfw-select" id="scfw-shape">
                    <option value="æ–¹å½¢">æ–¹å½¢</option>
                    <option value="åœ“å½¢">åœ“å½¢</option>
                    <option value="æ©¢åœ“å½¢">æ©¢åœ“å½¢</option>
                    <option value="é•·æ–¹å½¢">é•·æ–¹å½¢</option>
                </select>
            </div>
            
            <div class="scfw-control">
                <label class="scfw-label">è£é£¾åœ–æ¡ˆ</label>
                <select class="scfw-select" id="scfw-pattern">
                    <option value="">ç„¡</option>
                    <option value="ç³–æœ">ç³–æœ</option>
                    <option value="æ„›å¿ƒ">æ„›å¿ƒ</option>
                    <option value="å°èŠ±">å°èŠ±</option>
                </select>
            </div>
            
            <div class="scfw-control">
                <label class="scfw-label">æ–‡å­—é¡è‰²</label>
                <select class="scfw-select" id="scfw-color">
                    <option value="#dc3545">æœ±ç´…</option>
                    <option value="#000000">é»‘è‰²</option>
                    <option value="#0066cc">è—è‰²</option>
                    <option value="#28a745">ç¶ è‰²</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- è¼‰å…¥å­—é«”æŒ‰éˆ• -->
    <button class="scfw-load-btn" id="scfw-load-btn">
        è¼‰å…¥æ‰€æœ‰å­—é«”é è¦½
    </button>
    
    <!-- å­—é«”ç¶²æ ¼ -->
    <div class="scfw-font-grid" id="scfw-font-grid">
        <div class="scfw-loading">é»æ“Šä¸Šæ–¹æŒ‰éˆ•è¼‰å…¥å­—é«”</div>
    </div>
</div>

<script>
(function() {
    // å°è£çš„ç¨‹å¼ç¢¼
    const widget = document.getElementById('stamp-custom-font-widget');
    if (!widget) return;
    
    // å­—é«”æ¸…å–®é…ç½® - ä½¿ç”¨æ‚¨çš„å­—é«”
    const availableFonts = [
        { id: 1, name: 'ç²‰åœ“é«”', filename: 'ç²‰åœ“é«”å…¨ç¹é«”.ttf', displayName: 'ç²‰åœ“é«”' },
        { id: 2, name: 'ç²’ç·šé«”ä¸ç­‰å¯¬', filename: 'ç²’ç·šé«”ä¸ç­‰å¯¬å…¨ç¹é«”.ttf', displayName: 'ç²’ç·šé«”(ä¸ç­‰å¯¬)' },
        { id: 3, name: 'ç²’ç·šé«”ç­‰å¯¬', filename: 'ç²’ç·šé«”ç­‰å¯¬å…¨ç¹é«”.ttf', displayName: 'ç²’ç·šé«”(ç­‰å¯¬)' },
        { id: 4, name: 'ç²—ç·šé«”ä¸ç­‰å¯¬', filename: 'ç²—ç·šé«”ä¸ç­‰å¯¬ç‰ˆ å…¨ç¹é«”.ttf', displayName: 'ç²—ç·šé«”(ä¸ç­‰å¯¬)' },
        { id: 5, name: 'ç²—ç·šé«”ç­‰å¯¬', filename: 'ç²—ç·šé«”ç­‰å¯¬ç‰ˆ å…¨ç¹é«”.ttf', displayName: 'ç²—ç·šé«”(ç­‰å¯¬)' },
        { id: 6, name: 'èƒ–è¥¿æ‰‹å¯«é«”', filename: 'èƒ–è¥¿æ‰‹å¯«é«” å…¨ç¹é«”.ttf', displayName: 'èƒ–è¥¿æ‰‹å¯«é«”' },
        { id: 7, name: 'è¾°å®‡è½é›é«”', filename: 'è¾°å®‡è½é›é«” ä¸ç­‰å¯¬ç‰ˆå…¨ç¹é«”.ttf', displayName: 'è¾°å®‡è½é›é«”' },
        // åŠ å…¥å‚³çµ±å­—é«”
        { id: 8, name: 'æ¥·æ›¸', filename: '', displayName: 'æ¥·æ›¸', systemFont: 'KaiTi, "æ¨™æ¥·é«”", serif' },
        { id: 9, name: 'éš¸æ›¸', filename: '', displayName: 'éš¸æ›¸', systemFont: '"éš¸æ›¸", FangSong, serif' },
        { id: 10, name: 'ç¯†æ›¸', filename: '', displayName: 'ç¯†æ›¸', systemFont: 'SimSun, "å®‹é«”", serif' }
    ];
    
    // GitHub å­—é«” URL
    const GITHUB_RAW_URL = 'https://raw.githubusercontent.com/DK0124/font-preview-system/main/fonts/';
    
    // åœ–æ¡ˆå°æ‡‰
    const patterns = {
        'ç³–æœ': 'ğŸ¬',
        'æ„›å¿ƒ': 'â¤ï¸',
        'å°èŠ±': 'ğŸŒ¸'
    };
    
    // ç‹€æ…‹
    let currentSelection = {
        text: 'å°ç« é è¦½',
        font: '',
        fontId: null,
        shape: 'æ–¹å½¢',
        pattern: '',
        color: '#dc3545'
    };
    
    let loadedFonts = {};
    let isLoading = false;
    
    // å…ƒç´ 
    const elements = {
        textInput: widget.querySelector('#scfw-text'),
        shapeSelect: widget.querySelector('#scfw-shape'),
        patternSelect: widget.querySelector('#scfw-pattern'),
        colorSelect: widget.querySelector('#scfw-color'),
        fontGrid: widget.querySelector('#scfw-font-grid'),
        loadBtn: widget.querySelector('#scfw-load-btn'),
        syncStatus: document.getElementById('scfw-sync-status')
    };
    
    // è¼‰å…¥å­—é«”
    async function loadFont(fontData) {
        // å¦‚æœæ˜¯ç³»çµ±å­—é«”ï¼Œç›´æ¥è¿”å›
        if (fontData.systemFont) {
            return true;
        }
        
        // å¦‚æœå·²è¼‰å…¥ï¼Œè¿”å›
        if (loadedFonts[fontData.id]) {
            return loadedFonts[fontData.id];
        }
        
        try {
            const fontUrl = GITHUB_RAW_URL + encodeURIComponent(fontData.filename);
            const fontFace = new FontFace(
                `CustomFont${fontData.id}`, 
                `url(${fontUrl})`
            );
            
            await fontFace.load();
            document.fonts.add(fontFace);
            loadedFonts[fontData.id] = fontFace;
            
            return fontFace;
        } catch (error) {
            console.error(`è¼‰å…¥å­—é«”å¤±æ•— ${fontData.name}:`, error);
            return null;
        }
    }
    
    // å‰µå»ºå­—é«”å¡ç‰‡
    function createFontCard(fontData) {
        const card = document.createElement('div');
        card.className = 'scfw-font-card';
        card.dataset.fontId = fontData.id;
        card.dataset.fontName = fontData.name;
        
        // åˆå§‹ HTML
        card.innerHTML = `
            <div class="scfw-stamp-preview">
                <div class="scfw-font-loading">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="scfw-font-name">${fontData.displayName}</div>
        `;
        
        // è¼‰å…¥å­—é«”å¾Œæ›´æ–°é è¦½
        loadFont(fontData).then((loaded) => {
            if (loaded) {
                const previewDiv = card.querySelector('.scfw-stamp-preview');
                previewDiv.innerHTML = `
                    <div class="scfw-stamp ${currentSelection.shape}">
                        <span class="scfw-stamp-text" style="
                            font-family: ${fontData.systemFont || `CustomFont${fontData.id}`};
                            color: ${currentSelection.color};
                        ">
                            ${currentSelection.text || 'ç¯„ä¾‹'}
                        </span>
                        <span class="scfw-stamp-pattern">
                            ${patterns[currentSelection.pattern] || ''}
                        </span>
                    </div>
                `;
            } else {
                const previewDiv = card.querySelector('.scfw-stamp-preview');
                previewDiv.innerHTML = '<div class="scfw-font-loading">è¼‰å…¥å¤±æ•—</div>';
            }
        });
        
        // é»æ“Šäº‹ä»¶
        card.addEventListener('click', function() {
            // ç§»é™¤å…¶ä»–é¸ä¸­
            widget.querySelectorAll('.scfw-font-card').forEach(c => 
                c.classList.remove('selected')
            );
            
            // æ·»åŠ é¸ä¸­
            this.classList.add('selected');
            
            // æ›´æ–°é¸æ“‡
            currentSelection.font = fontData.name;
            currentSelection.fontId = fontData.id;
            
            // åŒæ­¥åˆ° BV SHOP
            syncToBVShop('font', fontData.name);
        });
        
        return card;
    }
    
    // æ›´æ–°æ‰€æœ‰é è¦½
    function updateAllPreviews() {
        widget.querySelectorAll('.scfw-font-card').forEach(card => {
            const fontId = parseInt(card.dataset.fontId);
            const fontData = availableFonts.find(f => f.id === fontId);
            
            if (fontData) {
                const stampEl = card.querySelector('.scfw-stamp');
                const textEl = card.querySelector('.scfw-stamp-text');
                const patternEl = card.querySelector('.scfw-stamp-pattern');
                
                if (stampEl && textEl && patternEl) {
                    // æ›´æ–°å½¢ç‹€
                    stampEl.className = 'scfw-stamp ' + currentSelection.shape;
                    
                    // æ›´æ–°æ–‡å­—
                    textEl.textContent = currentSelection.text || 'ç¯„ä¾‹';
                    textEl.style.color = currentSelection.color;
                    
                    // æ›´æ–°åœ–æ¡ˆ
                    patternEl.textContent = patterns[currentSelection.pattern] || '';
                }
            }
        });
    }
    
    // è¼‰å…¥æ‰€æœ‰å­—é«”
    async function loadAllFonts() {
        if (isLoading) return;
        
        isLoading = true;
        elements.loadBtn.disabled = true;
        elements.loadBtn.textContent = 'è¼‰å…¥ä¸­...';
        elements.fontGrid.innerHTML = '';
        
        // å‰µå»ºæ‰€æœ‰å­—é«”å¡ç‰‡
        for (const fontData of availableFonts) {
            const card = createFontCard(fontData);
            elements.fontGrid.appendChild(card);
        }
        
        elements.loadBtn.style.display = 'none';
        isLoading = false;
    }
    
    // é¡¯ç¤ºåŒæ­¥ç‹€æ…‹
    function showSyncStatus() {
        elements.syncStatus.style.display = 'block';
        setTimeout(() => {
            elements.syncStatus.style.display = 'none';
        }, 2000);
    }
    
    // åŒæ­¥åˆ° BV SHOP
    function syncToBVShop(field, value) {
        try {
            switch(field) {
                case 'text':
                    const textInput = document.querySelector('input[placeholder="è¼¸å…¥å…­å­—å…§"]');
                    if (textInput) {
                        textInput.value = value;
                        textInput.dispatchEvent(new Event('input', { bubbles: true }));
                        textInput.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                    break;
                    
                case 'font':
                    const fontSelect = findBVSelect('å­—é«”');
                    if (fontSelect) {
                        // å˜—è©¦æ‰¾åˆ°å°æ‡‰çš„é¸é …
                        let foundOption = false;
                        for (let i = 0; i < fontSelect.options.length; i++) {
                            if (fontSelect.options[i].text === value || 
                                fontSelect.options[i].value === value) {
                                fontSelect.selectedIndex = i;
                                foundOption = true;
                                break;
                            }
                        }
                        
                        if (foundOption) {
                            fontSelect.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    }
                    break;
                    
                case 'shape':
                    const shapeSelect = findBVSelect('å½¢ç‹€');
                    if (shapeSelect) {
                        shapeSelect.value = value;
                        shapeSelect.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                    break;
                    
                case 'pattern':
                    const patternSelect = findBVSelect('åœ–æ¡ˆ');
                    if (patternSelect) {
                        patternSelect.value = value || '';
                        patternSelect.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                    break;
            }
            
            showSyncStatus();
        } catch (error) {
            console.error('åŒæ­¥éŒ¯èª¤:', error);
        }
    }
    
    // å°‹æ‰¾ BV SHOP é¸æ“‡å™¨
    function findBVSelect(labelText) {
        const labels = document.querySelectorAll('label');
        for (let label of labels) {
            if (label.textContent.trim() === labelText) {
                const select = label.parentElement.querySelector('select');
                if (select) return select;
            }
        }
        return null;
    }
    
    // ç¶å®šäº‹ä»¶
    elements.textInput.addEventListener('input', function(e) {
        currentSelection.text = e.target.value;
        updateAllPreviews();
        syncToBVShop('text', e.target.value);
    });
    
    elements.shapeSelect.addEventListener('change', function(e) {
        currentSelection.shape = e.target.value;
        updateAllPreviews();
        syncToBVShop('shape', e.target.value);
    });
    
    elements.patternSelect.addEventListener('change', function(e) {
        currentSelection.pattern = e.target.value;
        updateAllPreviews();
        syncToBVShop('pattern', e.target.value);
    });
    
    elements.colorSelect.addEventListener('change', function(e) {
        currentSelection.color = e.target.value;
        updateAllPreviews();
    });
    
    elements.loadBtn.addEventListener('click', loadAllFonts);
    
    // å¾ BV SHOP è¼‰å…¥åˆå§‹å€¼
    function loadFromBVShop() {
        const textInput = document.querySelector('input[placeholder="è¼¸å…¥å…­å­—å…§"]');
        if (textInput && textInput.value) {
            elements.textInput.value = textInput.value;
            currentSelection.text = textInput.value;
        }
        
        const shapeSelect = findBVSelect('å½¢ç‹€');
        if (shapeSelect && shapeSelect.value) {
            elements.shapeSelect.value = shapeSelect.value;
            currentSelection.shape = shapeSelect.value;
        }
        
        const patternSelect = findBVSelect('åœ–æ¡ˆ');
        if (patternSelect && patternSelect.value) {
            elements.patternSelect.value = patternSelect.value;
            currentSelection.pattern = patternSelect.value;
        }
    }
    
    // åˆå§‹åŒ–
    setTimeout(() => {
        loadFromBVShop();
    }, 500);
    
})();
</script>